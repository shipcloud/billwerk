version: 2.1
jobs:
  standard:
    docker:
      - environment:
          BUNDLE_DISABLE_VERSION_CHECK: 1
          LANG: en_US.UTF-8
        image: cimg/ruby:3.2.2
    steps:
      - checkout
      - run:
          command: gem update --system; bin/setup
          name: Install ruby dependencies
      - run:
          command: bundle exec standardrb
          name: Run standardrb
  build:
    parameters:
      image-tag:
        description: The target docker image
        type: string
    docker:
      - environment:
          BUNDLE_DISABLE_VERSION_CHECK: 1
          LANG: en_US.UTF-8
        image: cimg/<< parameters.image-tag >>
    steps:
      - checkout
      - run:
          command: gem update --system; bin/setup
          name: Install ruby dependencies
      - run:
          command: |
            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            chmod +x ./cc-test-reporter
          name: Install Code Climate test-reporter
      - run:
          command: ./cc-test-reporter before-build
          name: Prepare Code Climate test-reporter
      - run:
          command: bundle exec rake
          name: Execute specs
      - run:
          command: ./cc-test-reporter after-build --exit-code $?
          name: Report coverage

workflows:
  build:
    jobs:
      - standard
      - build:
          matrix:
            parameters:
              image-tag:
                - "ruby:3.2"
  version-check:
    jobs:
      - build:
          matrix:
            parameters:
              image-tag:
                - ruby:3.0
                - ruby:3.1
                - ruby:3.2
